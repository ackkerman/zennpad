openapi: 3.0.3
info:
  title: ZennPad Extension Internal Contracts
  version: 0.1.0
  description: Command-level contracts for VS Code extension features (conceptual, tech-agnostic).
paths:
  /auth/sign-in:
    post:
      summary: Start GitHub auth (browser or PAT) and persist session.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                method:
                  type: string
                  enum: [browser, pat]
                token:
                  type: string
                  description: PAT when method=pat
              required: [method]
      responses:
        '200':
          description: Auth session established
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthSession'
  /auth/sign-out:
    post:
      summary: Clear stored credentials and session state.
      responses:
        '204':
          description: Signed out

  /repos/{repoId}/tree:
    get:
      summary: List Zenn content tree (articles/books/drafts/images/extra).
      parameters:
        - in: path
          name: repoId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Tree loaded from cache or GitHub
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tree'

  /content/{path}:
    get:
      summary: Fetch content with frontmatter and metadata.
      parameters:
        - in: path
          name: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Content retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContentItem'

  /content:
    post:
      summary: Create new article/book/chapter/draft using templates.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NewContentRequest'
      responses:
        '201':
          description: Content created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContentItem'

  /content/{path}/publish:
    patch:
      summary: Toggle published flag and return updated URLs.
      parameters:
        - in: path
          name: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                published:
                  type: boolean
              required: [published]
      responses:
        '200':
          description: Publish state updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContentItem'

  /images:
    post:
      summary: Save pasted/dropped/selected image under /images and return markdown link.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                mime:
                  type: string
                size:
                  type: integer
                dataRef:
                  type: string
                  description: reference/uri to the image payload
              required: [mime, size, dataRef]
      responses:
        '201':
          description: Image stored
          content:
            application/json:
              schema:
                type: object
                properties:
                  path:
                    type: string
                  markdown:
                    type: string
                  skipped:
                    type: boolean
                  reason:
                    type: string

  /search:
    get:
      summary: Search filenames, titles, and body with toggles.
      parameters:
        - in: query
          name: q
          required: true
          schema:
            type: string
        - in: query
          name: caseSensitive
          schema:
            type: boolean
        - in: query
          name: wholeWord
          schema:
            type: boolean
        - in: query
          name: regex
          schema:
            type: boolean
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/SearchResult'

  /preview:
    post:
      summary: Start preview backend/proxy for a repo and open initial path.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                path:
                  type: string
              required: [path]
      responses:
        '200':
          description: Preview ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PreviewSession'
    delete:
      summary: Stop preview backend/proxy.
      responses:
        '204':
          description: Preview stopped

  /sync/state:
    get:
      summary: Get sync queue status and pending items.
      responses:
        '200':
          description: Sync status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncState'

  /sync/flush:
    post:
      summary: Manually push pending changes to work branch.
      responses:
        '202':
          description: Flush scheduled

  /deploy:
    post:
      summary: Promote work branch changes to main with confirmation.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                confirm:
                  type: boolean
              required: [confirm]
      responses:
        '202':
          description: Deploy scheduled with confirmation

components:
  schemas:
    AuthSession:
      type: object
      properties:
        provider:
          type: string
          example: github
        method:
          type: string
          enum: [browser, pat]
        status:
          type: string
          enum: [valid, expired, revoked]
        scopes:
          type: array
          items:
            type: string
    Tree:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ContentItem'
    ContentItem:
      type: object
      properties:
        type:
          type: string
          enum: [article, book, chapter, draft, image, file, folder]
        path:
          type: string
        slug:
          type: string
        frontmatter:
          $ref: '#/components/schemas/Frontmatter'
        sha:
          type: string
        published:
          type: boolean
        updatedAt:
          type: string
          format: date-time
        createdAt:
          type: string
          format: date-time
        children:
          type: array
          items:
            $ref: '#/components/schemas/ContentItem'
    Frontmatter:
      type: object
      properties:
        title:
          type: string
        emoji:
          type: string
        type:
          type: string
        topics:
          type: array
          items:
            type: string
        published:
          type: boolean
        publishedAt:
          type: string
          format: date-time
    NewContentRequest:
      type: object
      properties:
        type:
          type: string
          enum: [article, book, chapter, draft]
        title:
          type: string
        topics:
          type: array
          items:
            type: string
        emoji:
          type: string
      required: [type, title]
    SearchResult:
      type: object
      properties:
        path:
          type: string
        title:
          type: string
        snippet:
          type: string
        matchType:
          type: string
          enum: [filename, title, body]
        position:
          type: object
          properties:
            line:
              type: integer
            column:
              type: integer
        score:
          type: number
    PreviewSession:
      type: object
      properties:
        mirrorPath:
          type: string
        backendPort:
          type: integer
        proxyPort:
          type: integer
        status:
          type: string
          enum: [stopped, starting, ready, error]
        lastError:
          type: string
    SyncState:
      type: object
      properties:
        pending:
          type: integer
        lastSyncedAt:
          type: string
          format: date-time
        autoSyncPaused:
          type: boolean
        workBranch:
          type: string
        mainBranch:
          type: string
